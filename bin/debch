#!/bin/bash
GIT_ARCHIVES="origin netz"
if [ -s /etc/default/sourcemgr ]  ; then
. /etc/default/sourcemgr
fi

set -e

if [ $(git status --porcelain | fgrep '^?' | wc -l) -gt 0 ] ; then
	echo "You have spurious files." >&2
	exit 1
fi
if [ $(git status --porcelain | wc -l) -eq 0 ] ; then
	echo "You have no uncommitted changes. Proceeding to upload."
else

trap 'echo FAIL >&2' 0

if [ -z "$EMAIL" ] && ! grep -qs '^DEBEMAIL=' $HOME/.devscripts.conf ; then
	echo "(DEB)EMAIL muss gesetzt sein" >&2
	exit 1
fi
. $HOME/.devscripts.conf 
export DEBEMAIL

dist=$(dpkg-parsechangelog | sed -ne 's/^Distribution:.//p')

mt=$(stat -c '%Y' debian/changelog)
debchange -U -i --distribution $dist --force-distribution
if [ $(stat -c '%Y' debian/changelog) = $mt ] ; then exit 1; fi

TF=$(tempfile)
trap 'rm -f $TF; echo FAIL >&2' 0
trap 'rm -f $TF' 0 1 2 15

dpkg-parsechangelog | sed -e '1,/^Changes:/d' |tail -n +3|sed -e 's/^   //' > $TF
if test -d debian/.git ; then
	cd debian
fi
git commit -a -e -F $TF

fi

if [ -n "$GIT_ARCHIVES" ] ; then
	for a in $GIT_ARCHIVES ; do
		git push $a && rm -f $TF
	done
	if [ -f $TF ] ; then
		echo "Could not push to any archive. Fix it." >&2
		exit 1
	fi
fi

S=$(dpkg-parsechangelog | sed -ne 's/^Source: *//p')
V=$(dpkg-parsechangelog | sed -ne 's/^Version: *//p' | sed -e s/^42://)
CF=${S}_${V}_$(dpkg --print-architecture).changes
if [ -s ../$CF ] ; then
	echo "Changes file found. Not building."
else
	debuild -i -b -us -uc
fi
dput -u smurf ../$CF

trap '' 0
echo OK
