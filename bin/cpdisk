#!/bin/sh

PATH=/usr/src/STATUS/bin:$PATH

usage() {
cat >&2 <<END
Usage: $0
       [ -f /dev/fd0 | -d /path ]
    module...
END
exit 1
}

cd /usr/src || die "No sources"

if test $# -eq 0 ; then usage ; fi

fd=/dev/fd0
dir=

   set -- `getopt f: $*`
   if test $? != 0
   then
	   usage
   fi
   for i
   do
	   case "$i"
	   in
		   -d)
			   dir=$2; fd= ; shift; shift;;
		   -f)
			   fd=$2; shift; shift;;
		   --)
			   shift; break;;
	   esac
   done

if test -z "$1"; then usage; fi

if test -z "$dir" ; then

disk=/tmp/disk-$$

echo 'Unmounting..?'
umount $disk || true
rm -rf $disk

mkfs -t ext2 $fd
mkdir $disk
echo Mounting disk
mount -t ext2 $fd $disk

dir=$disk
fi

for i ; do
  if test -f STATUS/out/$i ; then
    cat STATUS/out/$i
  else
    echo "Cannot copy $i -- not found" >&2
  fi
done | cpio -pvd $dir

if test -n "$fd" ; then
umount $disk
rmdir $disk
fi
