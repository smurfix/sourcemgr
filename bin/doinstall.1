#!/bin/sh

insmod /modules/floppy.o; mount -t ext2 /dev/fd0 /fd

if test ! -s /fd/STATUS ; then
	echo "keine Statusdatei gefunden, lege sie an."

	echo -n "System (pci): "; read who; if test -z "$who"; then who="pci"; fi
	echo -n "Ziel (193.141.54.134): "; read slave; if test -z "$slave"; then slave="193.141.54.134"; fi
	echo -n "Netzbits (26): "; read netbits; if test -z "$netbits"; then netbits=26; fi
	set -- $(/sbin/ipwhat $slave $netbits)
	# 255.255.255.192 10.20.30.0 10.20.30.63 10.20.30.1 
	mask=$1
	netz=$2
	broad=$3
	defdef=$4

	echo -n "Defaultrouter ($defdef): "; read def; if test -z "$def"; then def="$defdef"; fi
	echo -n "Quelle ($defdef): "; read master; if test -z "$master"; then master="$defdef"; fi
	echo -n "Hostname (install.noris.de): "; read name; if test -z "$name"; then name="install.noris.de"; fi

	echo "### KONFIGDATEN" >/fd/STATUS 

	echo "export who=$who" >>/fd/STATUS
	echo "export master=$master" >>/fd/STATUS
	echo "export slave=$slave" >>/fd/STATUS
	echo "export mask=$mask" >>/fd/STATUS
	echo "export broad=$broad" >>/fd/STATUS
	echo "export netz=$netz" >>/fd/STATUS
	echo "export def=$def" >>/fd/STATUS
	echo "export name=$name" >>/fd/STATUS
fi

. /fd/STATUS

found=
while read a b ; do 
	if test "$a" = "eth0:" ; then found=ja; fi
done < /proc/net/dev

if test -n "$found" ; then
	echo "Ethernettreiber ist geladen."
else
	echo "Ethernettreiber nicht gefunden => installiere und konfiguriere."
   set -e

   echo -n "Ethernet-Treiber (wd.o): "
   read foo

	echo -n "insmod "
   insmod /modules/${foo:-wd.o}
fi
	echo -n "ifconfig "
ifconfig eth0 $slave netmask $mask
	echo -n "netroute "
route add -net $netz netmask $mask
	echo -n "defaultroute "
route add default gw $def
	echo done.

if test -d /cd/bin ; then
	echo "/cd/bin gefunden."
else
	echo -n "/cd/bin nicht gefunden => mount "
   mount ${master}:/ /cd
   echo -n "ldconfig "
   ldconfig -X >/dev/null 2>&1
	echo done.
fi

exec /cd/usr/src/STATUS/bin/doinstall.2
