#!/bin/sh

insmod /modules/floppy.o; insmod /modules/ext2.o; mount -t ext2 /dev/fd0 /fd
insmod /modules/sunrpc.o; insmod /modules/lockd.o; insmod /modules/nfs.o

eth=eth0

if test ! -s /fd/STATUS ; then
	echo "keine Statusdatei gefunden, lege sie an."

	echo -n "System (pci): "; read who; if test -z "$who"; then who="pci"; fi
	echo -n "Ziel (193.141.54.134): "; read slave; if test -z "$slave"; then slave="193.141.54.134"; fi
	echo -n "Netzbits (26): "; read netbits; if test -z "$netbits"; then netbits=26; fi
	set -- $(/sbin/ipwhat $slave $netbits)
	# 255.255.255.192 10.20.30.0 10.20.30.63 10.20.30.1 
	mask=$1
	netz=$2
	broad=$3
	defdef=$4

	echo -n "Defaultrouter ($defdef): "; read def; if test -z "$def"; then def="$defdef"; fi
	echo -n "Quelle ($defdef): "; read master; if test -z "$master"; then master="$defdef"; fi
	echo -n "Hostname (install.noris.de): "; read name; if test -z "$name"; then name="install.noris.de"; fi
	echo -n "Disk (sda): "; read disk; if test -z "$disk"; then disk="sda"; fi
	echo -n "Ethernet (eth0): "; read eth; if test -z "$eth"; then eth="eth0"; fi

	echo "### KONFIGDATEN" >/fd/STATUS 

	echo "export who=$who" >>/fd/STATUS
	echo "export master=$master" >>/fd/STATUS
	echo "export slave=$slave" >>/fd/STATUS
	echo "export mask=$mask" >>/fd/STATUS
	echo "export imask=$netbits" >>/fd/STATUS
	echo "export broad=$broad" >>/fd/STATUS
	echo "export netz=$netz" >>/fd/STATUS
	echo "export def=$def" >>/fd/STATUS
	echo "export name=$name" >>/fd/STATUS
	echo "export disk=$disk" >>/fd/STATUS
	echo "export eth=$eth" >>/fd/STATUS
fi

. /fd/STATUS

ifconfig lo 127.0.0.1
route add 127.0.0.1 dev lo

found=
while read a b ; do 
	if test "$a" = "${eth}:" ; then found=ja; fi
done < /proc/net/dev

if test -n "$found" ; then
	echo "Ethernettreiber ist geladen."
else
	echo "Ethernettreiber nicht gefunden => installiere und konfiguriere."
   set -e

   if test -z "$ETHER" ; then
   echo -n "Ethernet-Treiber (wd.o): "
   read ETHER
   echo export ETHER=\""$ETHER"\" >>/fd/STATUS
   fi

	echo -n "insmod "
   insmod /modules/${foo:-wd.o}
fi
	echo -n "ifconfig "
ifconfig ${eth} $slave netmask $mask
	echo -n "netroute "
set +e
route add -net $netz netmask $mask
	echo -n "defaultroute "
route add default gw $def
	echo done.
set -e

if test -d /cd/bin ; then
	echo "/cd/bin gefunden."
else
	echo -n "/cd/bin nicht gefunden => mount "
   mount -o timeo=20,hard,intr,nolock ${master}:/ /cd
	echo done.
fi

export LD_LIBRARY_PATH=/mnt/lib:/cd/lib
exec /cd/usr/src/STATUS/bin/doinstall.2
