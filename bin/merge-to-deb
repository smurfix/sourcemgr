#!/bin/sh
set -ex

B="$(git rev-parse --abbrev-ref HEAD)"
if test "$B" = "deb" ; then
    echo "You can't be on the Debian branch when you do this." >&2
    exit 1
fi

T=$(git describe --tags --exact-match)
git checkout deb
git merge --no-commit "$B"
if dpkg-parsechangelog -S version | grep -qs -- - ; then D="-1" ; else D=".1"; fi
debchange -r -v "$T$D" "Merge"
git add debian/changelog
git commit -m "Merge to $T"
debch
git checkout "$B"
