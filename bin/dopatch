#!/bin/sh

rm -rf _PATCH_
mkdir _PATCH_

if [ -z "$4" ] ; then
	echo "Usage: $(basename "$0") patchdepth r-lastversion r-version rel/dir descr" >&2
	exit 1
fi

pd="$1"
lastvers="$2"
vers="$3"
dir="$4"
shift; shift; shift; shift
rel="$*"

perl -e '

while(<>) {
	if(/^Index:\s+(\S+)/) {
		$ind = $1;
		next;
	}
	if(/^diff\s+(\S+)/) {
		$fl = 1;
		next;
	}
	if(/^\*\*\*\s+(\S+)/) {
		$fl = 2;
		next;
	} else {
		$fl = 0;
	}
	if($fl ? /^\-\-\-\s+(\S+)/ : /^\+\+\+\s+(\S+)/) {
		$fl = 0;
		if($ind ne "") {
			$f = $ind; $ind = "";
		} else {
			$f = $1;
		}
		$f =~ s/^([^\/]*\/){'"$pd"'}// if '"$pd"';
		if($f =~ /\//) {
			$d = $f;
			$d =~ s/\/[^\/]*$//;
			system("mkdir -p _PATCH_/$d") unless $did{$d}++;
		}
		system("cp -a $f _PATCH_/$f");
	}
} continue {
	print;
}

' | patch -p"$pd" -d _PATCH_

cd _PATCH_
cvs import -m "$rel" "$dir" dist "$vers"
find . -type f -size 0 | while read a ; do rm ../$a; done
find . -type f | while read a ; do mv -f $a ../$a; done
cd ..
rm -rf _PATCH_
cvs rtag -r "$lastvers" "$vers" "$dir"
