#!/bin/bash
. /usr/share/sourcemgr/repository

set -e
trap 'usage; exit 1' 0

usage() {
cat >&2 <<END
Usage: $(basename $0)  -- import a new version from an external tree
       [ -d package ] [ -t TAG ]
       [ -v oldbranch ] [ -w newbranch [ -p (copy to publlic archive) ] ]
       [ -n (keep Bitkeeper metadata) ]
       directory
       comment

This script incrementally imports an external tree (e.g., an unpacked
tarball). It calls "bk rename" if there are both new and removed files,
so you can track upstream's rename operations.

END
}

vers=-
nvers=not/given
dir=
ext=
parent=0
nodelete=
tag=
p=

   eval set -- "$(getopt "d:npt:v:w:h" "$@")"
   for i
   do
	   case "$i"
	   in
		   -h)
		       exit 1 ;;
		   -t)
			   shift; tag="$1"; shift;;
		   -d)
			   shift; dir="$1"; shift;;
		   -v)
			   shift; vers="$1"; shift;;
		   -w)
			   shift; nvers="$1"; shift;;
		   -n)
		       shift; nodelete=y ;;
		   -p)
		       shift; p="-p" ;;
			--)
				shift; break ;;
	   esac
   done

if test -z "$dir" ; then
	b.name > /tmp/bn.$$
	read dir overs < /tmp/bn.$$
	rm -f /tmp/bn.$$
fi

tmp=/var/tmp/bki.$$
trap 'rm -rf $tmp; usage; exit 1' 0

ddir="$1"
test -d "$ddir"
shift
cmt="$*"
test -n "$cmt"

if test "$nvers" = "not/given" ; then
	b.get -n -v "$vers" -d "$dir" $tmp
else
	b.get -n -v "$vers" -w "$nvers" $p -d "$dir" $tmp
fi

test -d "$tmp"

set -e

cd "$ddir"
ddir="$(pwd)"
# remove old Bitkeeper- and/or CVS-Dateien
( find . -type d \( -name SCCS -o -name CVS \) -prune -print | grep -v "^\./BitKeeper/";
  echo BitKeeper; echo CVSROOT ) | xargs rm -rf

# find the newest file modification time
zeit=$(perl -e '
 use File::Find;
 my $mtime=0;
 find(sub {
	return if -l $_;
	return unless -f $_;
	$t=(lstat($_))[9];
	$mtime=$t if $mtime<$t;
 }, ".");
 print $mtime;
');

done=/tmp/f.done.$$
trap 'rm -rf $done $tmp' 0

( cd $tmp; find . -type d -name SCCS -prune -print | grep -v "^\./BitKeeper/"
  echo BitKeeper ) |
( set -e
  while read a ; do
	mkdir -p "$(dirname "$a")"
	mv "$tmp/$a" "$a" || cp -a "$tmp/$a" "$a"
  done
  touch $done
)
test -f $done
rm -rf $tmp $done

sec=$(expr $(date '+%s') - $zeit)

# LD_PRELOAD=$DATEFUDGE_LIB DATEFUDGE=$(expr $(date '+%s') - $zeit) \
/usr/bin/b.import.pl "$cmt"

test -z "$tag" || bk tag -r+ "$tag"
bk push -q
echo "Import OK:" $(bk prs -ah -r+ -d:I: ChangeSet)
trap "" 0
rm -rf $tmp
test -z "$nodelete" || exit 0

rm -rf $tmp ChangeSet BitKeeper
find . -name SCCS -type d -prune -print0 | xargs -0r rm -rf
exit 0
