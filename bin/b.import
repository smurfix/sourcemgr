#!/bin/bash

set -e
trap 'usage; exit 1' 0

usage() {
cat >&2 <<END
Usage: $(basename $0)  -- checkt neue Version von externem Source ein
       [ -d Paket ]
       [ -v altes-Release ]
       [ -w neues-Release ]
       Verzeichnis-mit-neuem-Source
       Kommentar

importiert einen Dateibaum als "neue Version".

END
}

vers=extern
nvers=gibts/nicht
dir=
ext=
parent=0

   eval set -- "$(getopt "d:v:w:e:h" "$@")"
   for i
   do
	   case "$i"
	   in
		   -h)
		       exit 1 ;;
		   -d)
			   shift; dir="$1"; shift;;
		   -v)
			   shift; vers="$1"; shift;;
		   -w)
			   shift; nvers="$1"; shift;;
			--)
				shift; break ;;
	   esac
   done

if test -z "$dir" ; then
	b.name > /tmp/bn.$$
	read dir overs < /tmp/bn.$$
	rm -f /tmp/bn.$$
fi

tmp=/var/tmp/bki.$$
trap 'rm -rf $tmp; usage; exit 1' 0

ddir="$1"
test -d "$ddir"
shift
cmt="$*"
test -n "$cmt"

b.get -n -v "$vers" -w "$nvers" -d "$dir" $tmp
test -d "$tmp"

set -e

cd "$ddir"
ddir="$(pwd)"
# entferne alte Bitkeeper- und/oder CVS-Dateien
( find . -type d \( -name SCCS -o -name CVS \) -prune -print | grep -v "^\./BitKeeper/";
  echo BitKeeper; echo CVSROOT ) | xargs rm -rf

done=/tmp/f.done.$$
trap 'rm -rf $done $tmp' 0

( cd $tmp; find . -type d -name SCCS -prune -print | grep -v "^\./BitKeeper/"
  echo BitKeeper ) |
( set -e
  while read a ; do
	mkdir -p "$(dirname "$a")"
	mv "$tmp/$a" "$a" || cp -a "$tmp/$a" "$a"
  done
  touch $done
)
test -f $done
rm -rf $tmp $done

b.import.pl "$cmt"

bk push -q
echo "Import OK:" $(bk prs -ah -r+ -d:I: ChangeSet)
trap "" 0
rm -rf $tmp ChangeSet BitKeeper
find . -name SCCS -type d -prune -print0 | xargs -0r rm -rf
exit 0
