#!/bin/bash
if test -f /usr/lib/datefudge.so ; then
	FUDGE=/usr/lib/datefudge.so
elif test -f /usr/local/lib/datefudge.so ; then
	FUDGE=/usr/local/lib/datefudge.so
else
	echo "Date-changing library (datefudge.so) not found" >&2
	exit 1
fi

set -e
trap 'usage; exit 1' 0

usage() {
cat >&2 <<END
Usage: $(basename $0)  -- checkt neue Version von externem Source ein
       [ -d Paket ]
       [ -v altes-Release ]
       [ -w neues-Release ]
       [ -n ] (BK-Daten danach nicht löschen)
       Verzeichnis-mit-neuem-Source
       Kommentar

importiert einen Dateibaum als "neue Version".

END
}

vers=extern
nvers=gibts/nicht
dir=
ext=
parent=0
nodelete=

   eval set -- "$(getopt "d:nv:w:h" "$@")"
   for i
   do
	   case "$i"
	   in
		   -h)
		       exit 1 ;;
		   -d)
			   shift; dir="$1"; shift;;
		   -v)
			   shift; vers="$1"; shift;;
		   -w)
			   shift; nvers="$1"; shift;;
		   -n)
		       shift; nodelete=y ;;
			--)
				shift; break ;;
	   esac
   done

if test -z "$dir" ; then
	b.name > /tmp/bn.$$
	read dir overs < /tmp/bn.$$
	rm -f /tmp/bn.$$
fi

tmp=/var/tmp/bki.$$
trap 'rm -rf $tmp; usage; exit 1' 0

ddir="$1"
test -d "$ddir"
shift
cmt="$*"
test -n "$cmt"

if test "$nvers" = "gibts/nicht" ; then
	b.get -n -v "$vers" -d "$dir" $tmp
else
	b.get -n -v "$vers" -w "$nvers" -d "$dir" $tmp
fi

test -d "$tmp"

set -e

cd "$ddir"
zeit=$(perl -e '
 use File::Find;
 my $mtime=0;
 find(sub {
	return if -l $_;
	return unless -f $_;
	$t=(lstat($_))[9];
	$mtime=$t if $mtime<$t;
 }, ".");
 print $mtime;
');

ddir="$(pwd)"
# entferne alte Bitkeeper- und/oder CVS-Dateien
( find . -type d \( -name SCCS -o -name CVS \) -prune -print | grep -v "^\./BitKeeper/";
  echo BitKeeper; echo CVSROOT ) | xargs rm -rf

done=/tmp/f.done.$$
trap 'rm -rf $done $tmp' 0

( cd $tmp; find . -type d -name SCCS -prune -print | grep -v "^\./BitKeeper/"
  echo BitKeeper ) |
( set -e
  while read a ; do
	mkdir -p "$(dirname "$a")"
	mv "$tmp/$a" "$a" || cp -a "$tmp/$a" "$a"
  done
  touch $done
)
test -f $done
rm -rf $tmp $done

sec=$(expr $(date '+%s') - $zeit)

LD_PRELOAD=$FUDGE DATEFUDGE=$(expr $(date '+%s') - $zeit) \
b.import.pl "$cmt"

bk push -q
echo "Import OK:" $(bk prs -ah -r+ -d:I: ChangeSet)
trap "" 0
rm -rf $tmp
test -z "$nodelete" || exit 0

rm -rf $tmp ChangeSet BitKeeper
find . -name SCCS -type d -prune -print0 | xargs -0r rm -rf
exit 0
