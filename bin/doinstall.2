#!/bin/sh

. /fd/STATUS

PATH=/cd/usr/src/STATUS/bin:/bin:/sbin:/usr/sbin:/cd/bin:/cd/sbin:/cd/usr/bin:/cd/usr/sbin

if test -d /mnt/etc ; then
	echo "/mnt/etc gefunden."
else
	echo -n "kein /mnt/etc => konfiguriere deutsche Tastatur "

loadkeys /cd/usr/share/kbd/keytables/de-latin1-nodeadkeys.map 
	echo "und scsi-Module..."
insmod /cd/lib/modules-$who/$(uname -r)/scsi/scsi_mod.o
insmod /cd/lib/modules-$who/$(uname -r)/scsi/sd_mod.o
insmod /cd/lib/modules-$who/$(uname -r)/scsi/ncr*.o
# war mal der 'andere' Treiber, aber der tut besser
insmod /cd/lib/modules-$who/$(uname -r)/scsi/aic7xxx.o
insmod /cd/lib/modules-$who/$(uname -r)/scsi/aha1542.o
	echo -n "...done. "
swapoff -a
echo -n "Alles OK? "
read ans
if test "$ans" = "n" ; then exit 1 ; fi

echo "fdisk startet -- Root wird /dev/${disk}1."
fdisk /dev/$disk

echo -n "Swap <${disk}2>: "; read swap; swap=${swap:-${disk}2}
echo "Swap nach /dev/$swap"

/sbin/update
echo "Swapspace."
mkswap /dev/$swap
swapon /dev/$swap

# test -d /sbin/fs/ || ln -s /cd/sbin/fs /sbin/
/cd/sbin/fs/mkfs.ext2 /dev/${disk}1
mount -t ext2 /dev/${disk}1 /mnt

mkdir -p /mnt/proc /mnt/var /mnt/var/tmp /mnt/var/run /mnt/cd
ln -s /proc/mounts /mnt/var/run/mtab
touch /mnt/proc/mounts
ln -s var/tmp /mnt/tmp
# mkdir -p /var/tmp /usr/bin; ln -sf /cd/usr/bin/perl /usr/bin; ln -sf var/tmp /tmp

echo -n "Mountpoints nach (ab ${disk}3; '-' überspringt)...: "
read a

set -xe

mkdir /mnt/etc
cat >/mnt/etc/fstab <<EOF
/dev/${disk}1       /                         ext2            defaults   1   1
/dev/$swap       swap                      swap            defaults   0   0
none            /proc                     proc            defaults   0   0
EOF
pp=3; for i in $a ; do
	if test "x$i" != "x-" ; then
		mkdir -p /mnt/$i
		/cd/sbin/fs/mkfs.ext2 /dev/${disk}$pp
		mount -t ext2 /dev/${disk}$pp /mnt/$i
		echo "/dev/${disk}$pp       $i                         ext2            defaults   2   2" >>/mnt/etc/fstab
	fi
	pp=$(expr $pp + 1)
done
fi

exec /cd/usr/src/STATUS/bin/doinstall.2a
